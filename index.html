<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="PWA –¥–ª—è —Å–±–æ—Ä–∞ –≥–µ–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö —Å –∫–∞–º–µ—Ä–æ–π –∏ –æ—Ñ–ª–∞–π–Ω –±–∞–∑–æ–π">
    <meta name="theme-color" content="#2180B8">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icon-192.png">
    <title>Field Geology Data Collector v2.0</title>
    
    <style>
        :root {
            --color-primary: #2180B8;
            --color-primary-hover: #1a6a99;
            --color-success: #4CAF50;
            --color-error: #FF5757;
            --color-warning: #FFA726;
            --color-bg: #f5f5f5;
            --color-surface: #ffffff;
            --color-text: #333333;
            --color-text-light: #666666;
            --color-border: #e0e0e0;
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            font-size: 16px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--color-bg);
            color: var(--color-text);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }

        .container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background-color: var(--color-bg);
        }

        header {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-hover) 100%);
            color: white;
            padding: 1.5rem 1rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        header h1 {
            font-size: 1.8rem;
            font-weight: 600;
            letter-spacing: -0.5px;
        }

        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 1.5rem 1rem;
            max-width: 600px;
            margin: 0 auto;
            width: 100%;
        }

        .camera-section {
            width: 100%;
            margin-bottom: 2rem;
            background: var(--color-surface);
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            aspect-ratio: 16 / 9;
        }

        .camera-stream {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
            background: #000;
        }

        .form {
            background: var(--color-surface);
            padding: 1.5rem;
            border-radius: var(--radius-lg);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            margin-bottom: 2rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            font-weight: 600;
            font-size: 0.95rem;
            color: var(--color-text);
            margin-bottom: 0.5rem;
        }

        .form-input,
        .form-select {
            width: 100%;
            padding: 0.75rem 1rem;
            font-size: 1rem;
            border: 2px solid var(--color-border);
            border-radius: var(--radius-md);
            background: var(--color-surface);
            color: var(--color-text);
            transition: all 0.2s ease;
            -webkit-appearance: none;
            appearance: none;
        }

        .form-input:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(33, 128, 184, 0.1);
        }

        .form-select {
            cursor: pointer;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23666' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            padding-right: 2.5rem;
        }

        .record-count {
            background: linear-gradient(135deg, rgba(33, 128, 184, 0.1), rgba(76, 175, 80, 0.1));
            padding: 1rem;
            border-radius: var(--radius-md);
            border-left: 4px solid var(--color-primary);
            font-weight: 500;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .record-count strong {
            color: var(--color-primary);
            font-size: 1.3rem;
        }

        .error-message,
        .success-message {
            padding: 1rem;
            border-radius: var(--radius-md);
            margin-bottom: 1rem;
            font-weight: 500;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .error-message {
            background-color: rgba(255, 87, 87, 0.1);
            color: var(--color-error);
            border-left: 4px solid var(--color-error);
        }

        .success-message {
            background-color: rgba(76, 175, 80, 0.1);
            color: var(--color-success);
            border-left: 4px solid var(--color-success);
        }

        .buttons-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
            margin-top: 1.5rem;
        }

        .btn {
            padding: 0.75rem 1rem;
            border: none;
            border-radius: var(--radius-md);
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-hover) 100%);
            color: white;
            grid-column: 1 / -1;
        }

        .btn-primary:hover {
            box-shadow: 0 4px 12px rgba(33, 128, 184, 0.3);
        }

        .btn-secondary {
            background-color: #9E9E9E;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #757575;
        }

        .btn-warning {
            background-color: var(--color-warning);
            color: white;
        }

        .btn-danger {
            background-color: var(--color-error);
            color: white;
        }

        .btn-danger:hover {
            background-color: #E63946;
        }

        .dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.2s ease;
            backdrop-filter: blur(2px);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .dialog {
            background: white;
            padding: 2rem;
            border-radius: var(--radius-lg);
            max-width: 400px;
            min-width: 280px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .dialog h2 {
            margin: 0 0 0.5rem 0;
            font-size: 1.3rem;
            color: var(--color-text);
            font-weight: 600;
        }

        .dialog p {
            margin: 0 0 1.5rem 0;
            color: var(--color-text-light);
            font-size: 0.95rem;
            line-height: 1.4;
        }

        .dialog-buttons {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        .dialog-buttons .btn {
            flex: 1;
            min-height: 44px;
        }

        footer {
            background: var(--color-surface);
            border-top: 1px solid var(--color-border);
            padding: 1rem;
            text-align: center;
            color: var(--color-text-light);
            font-size: 0.9rem;
            margin-top: 2rem;
        }

        @media (max-width: 480px) {
            header h1 {
                font-size: 1.5rem;
            }

            main {
                padding: 1rem;
            }

            .buttons-group {
                grid-template-columns: 1fr;
            }

            .btn-primary {
                grid-column: 1;
            }

            .dialog {
                max-width: 90vw;
                padding: 1.5rem;
            }

            .dialog-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üî¨ –°–±–æ—Ä –≥–µ–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö</h1>
        </header>

        <main>
            <div class="camera-section">
                <video id="camera-video" autoplay playsinline muted class="camera-stream"></video>
            </div>

            <form id="data-form" class="form">
                <div class="form-group">
                    <label for="barcode-input">–®—Ç—Ä–∏—Ö–∫–æ–¥:</label>
                    <input id="barcode-input" type="text" placeholder="–°–∫–∞–Ω–∏—Ä—É–π—Ç–µ —à—Ç—Ä–∏—Ö–∫–æ–¥" readonly class="form-input"/>
                </div>

                <div class="form-group">
                    <label for="well-input">–°–∫–≤–∞–∂–∏–Ω–∞:</label>
                    <input id="well-input" type="tel" placeholder="–ù–æ–º–µ—Ä —Å–∫–≤–∞–∂–∏–Ω—ã" inputmode="numeric" pattern="[0-9]*" class="form-input"/>
                </div>

                <div class="form-group">
                    <label for="block-input">–ë–ª–æ–∫:</label>
                    <input id="block-input" type="tel" placeholder="–ù–æ–º–µ—Ä –±–ª–æ–∫–∞" inputmode="numeric" pattern="[0-9]*" class="form-input"/>
                </div>

                <div class="form-group">
                    <label for="rock-select">–ü–æ—Ä–æ–¥–∞:</label>
                    <select id="rock-select" class="form-select">
                        <option value="520">520</option>
                        <option value="360">360</option>
                        <option value="100">100</option>
                        <option value="200">200</option>
                        <option value="300">300</option>
                        <option value="400">400</option>
                        <option value="500">500</option>
                        <option value="600">600</option>
                        <option value="700">700</option>
                        <option value="800">800</option>
                    </select>
                </div>

                <div class="record-count">
                    –ó–∞–ø–∏—Å–µ–π –≤ –ë–î: <strong id="record-count">0</strong>
                </div>

                <div id="error-message" class="error-message" style="display: none;"></div>
                <div id="success-message" class="success-message" style="display: none;"></div>

                <div class="buttons-group">
                    <button type="submit" class="btn btn-primary" title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å">
                        üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å
                    </button>
                    <button type="button" id="export-btn" class="btn btn-secondary" title="–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ CSV">
                        üì• –≠–∫—Å–ø–æ—Ä—Ç
                    </button>
                    <button type="button" id="share-btn" class="btn btn-warning" title="–ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Ñ–∞–π–ª–æ–º">
                        üì§ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è
                    </button>
                    <button type="button" id="clear-btn" class="btn btn-danger" title="–û—á–∏—Å—Ç–∏—Ç—å –ø–æ–ª—è">
                        üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å
                    </button>
                </div>
            </form>
        </main>

        <div id="confirm-dialog" class="dialog-overlay" style="display: none;">
            <div class="dialog">
                <h2>–û—á–∏—Å—Ç–∏—Ç—å –ø–æ–ª—è?</h2>
                <p>–î–∞–Ω–Ω—ã–µ –≤ —Ñ–æ—Ä–º–µ –±—É–¥—É—Ç –ø–æ—Ç–µ—Ä—è–Ω—ã (–∫—Ä–æ–º–µ –±–ª–æ–∫–∞)</p>
                <div class="dialog-buttons">
                    <button type="button" id="cancel-btn" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</button>
                    <button type="button" id="confirm-btn" class="btn btn-danger">–û—á–∏—Å—Ç–∏—Ç—å</button>
                </div>
            </div>
        </div>

        <footer>
            v2.0 | –ë–µ–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞ ‚úÖ | –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω–æ
        </footer>
    </div>

    <script src="https://unpkg.com/@zxing/browser@0.1.5/esm/index.min.js"></script>

    <script>
        class GeologyDatabase {
            constructor() {
                this.db = null;
                this.dbName = 'FieldGeologyDB';
                this.storeName = 'geology_records';
                this.version = 1;
            }

            async init() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, this.version);
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => {
                        this.db = request.result;
                        console.log('[DB] ‚úÖ –ë–î –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');
                        resolve(this.db);
                    };
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains(this.storeName)) {
                            const store = db.createObjectStore(this.storeName, {
                                keyPath: 'id',
                                autoIncrement: true
                            });
                            store.createIndex('by_timestamp', 'timestamp', { unique: false });
                            store.createIndex('by_barcode', 'barcode', { unique: false });
                            store.createIndex('by_block', 'block', { unique: false });
                        }
                    };
                });
            }

            async addRecord(barcode, well, block, rockCode) {
                if (!this.db) await this.init();
                const timestamp = new Date().toISOString().slice(0, 19).replace('T', ' ');
                const record = {
                    timestamp,
                    barcode,
                    well: parseInt(well, 10),
                    block: parseInt(block, 10),
                    rockCode,
                    createdAt: new Date().toISOString()
                };

                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction([this.storeName], 'readwrite');
                    const store = tx.objectStore(this.storeName);
                    const request = store.add(record);
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => {
                        console.log('[DB] ‚úÖ –ó–∞–ø–∏—Å—å –¥–æ–±–∞–≤–ª–µ–Ω–∞:', record);
                        resolve(request.result);
                    };
                });
            }

            async getAllRecords() {
                if (!this.db) await this.init();
                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction([this.storeName], 'readonly');
                    const store = tx.objectStore(this.storeName);
                    const request = store.getAll();
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => resolve(request.result);
                });
            }

            async exportToCSV() {
                const records = await this.getAllRecords();
                let csv = 'timestamp;barcode;well;block;rock_code\n';
                for (const record of records) {
                    csv += `${record.timestamp};${record.barcode};${record.well};${record.block};${record.rockCode}\n`;
                }
                return csv;
            }

            async downloadCSV() {
                const csv = await this.exportToCSV();
                const timestamp = new Date().toISOString().slice(0, 19).replace(/[-:]/g, '');
                const filename = `geology_export_${timestamp}.csv`;
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.setAttribute('href', URL.createObjectURL(blob));
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                console.log('[EXPORT] ‚úÖ CSV —Å–∫–∞—á–∞–Ω:', filename);
                return filename;
            }
        }

        class BarcodeScanner {
            constructor() {
                this.codeReader = null;
                this.scanning = false;
                this.lastScannedBarcode = '';
                this.scanInterval = 100;
                this.scanTimestamp = 0;
                this.videoElement = null;
                this.stream = null;
            }

            async startScanning(videoElement, onDetected) {
                try {
                    console.log('[CAMERA] –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞–º–µ—Ä—ã (10 FPS)...');
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: {
                            facingMode: 'environment',
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        }
                    });
                    videoElement.srcObject = stream;
                    this.videoElement = videoElement;
                    this.stream = stream;
                    this.scanning = true;
                    this.codeReader = new ZXing.BrowserMultiFormatReader();
                    console.log('[CAMERA] ‚úÖ –ö–∞–º–µ—Ä–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');
                    this.scanFrames(videoElement, onDetected);
                } catch (error) {
                    console.error('[CAMERA] ‚ùå –û—à–∏–±–∫–∞:', error);
                    throw error;
                }
            }

            async scanFrames(videoElement, onDetected) {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const scan = async () => {
                    if (!this.scanning) return;
                    const now = Date.now();
                    if (now - this.scanTimestamp < this.scanInterval) {
                        requestAnimationFrame(scan);
                        return;
                    }
                    this.scanTimestamp = now;
                    try {
                        const videoWidth = videoElement.videoWidth;
                        const videoHeight = videoElement.videoHeight;
                        canvas.width = videoWidth;
                        canvas.height = videoHeight;
                        if (canvas.width > 0 && canvas.height > 0) {
                            ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
                            try {
                                const result = await this.codeReader.decodeFromCanvas(canvas);
                                if (result && result.text) {
                                    if (result.text !== this.lastScannedBarcode) {
                                        this.lastScannedBarcode = result.text;
                                        console.log('[BARCODE] ‚úÖ –†–∞—Å–ø–æ–∑–Ω–∞–Ω:', result.text);
                                        this.stopScanning();
                                        if (onDetected) onDetected(result.text);
                                        setTimeout(() => {
                                            this.lastScannedBarcode = '';
                                        }, 1000);
                                    }
                                }
                            } catch (error) {}
                        }
                        requestAnimationFrame(scan);
                    } catch (error) {
                        console.error('[SCAN] –û—à–∏–±–∫–∞:', error);
                        requestAnimationFrame(scan);
                    }
                };
                scan();
            }

            stopScanning() {
                if (!this.scanning) return;
                this.scanning = false;
                if (this.stream) {
                    this.stream.getTracks().forEach(track => track.stop());
                    this.stream = null;
                }
                if (this.videoElement) {
                    this.videoElement.srcObject = null;
                }
                console.log('[CAMERA] ‚úÖ –ö–∞–º–µ—Ä–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∞');
            }

            async restartScanning(videoElement, onDetected) {
                this.stopScanning();
                await new Promise(resolve => setTimeout(resolve, 500));
                await this.startScanning(videoElement, onDetected);
            }
        }

        class FieldGeologyApp {
            constructor() {
                this.database = new GeologyDatabase();
                this.scanner = new BarcodeScanner();
                this.elements = {
                    form: document.getElementById('data-form'),
                    barcodeInput: document.getElementById('barcode-input'),
                    wellInput: document.getElementById('well-input'),
                    blockInput: document.getElementById('block-input'),
                    rockSelect: document.getElementById('rock-select'),
                    recordCount: document.getElementById('record-count'),
                    errorMsg: document.getElementById('error-message'),
                    successMsg: document.getElementById('success-message'),
                    videoElement: document.getElementById('camera-video'),
                    exportBtn: document.getElementById('export-btn'),
                    shareBtn: document.getElementById('share-btn'),
                    clearBtn: document.getElementById('clear-btn'),
                    confirmDialog: document.getElementById('confirm-dialog'),
                    cancelBtn: document.getElementById('cancel-btn'),
                    confirmBtn: document.getElementById('confirm-btn')
                };
                this.init();
            }

            async init() {
                try {
                    await this.database.init();
                    this.loadBlockFromStorage();
                    await this.updateRecordCount();
                    await this.scanner.startScanning(
                        this.elements.videoElement,
                        (barcode) => this.handleBarcodeDetected(barcode)
                    );
                    this.attachEventListeners();
                    this.registerServiceWorker();
                    console.log('[APP] ‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ!');
                } catch (error) {
                    console.error('[APP] –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
                    this.showError('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ' + error.message);
                }
            }

            attachEventListeners() {
                this.elements.form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.saveRecord();
                });
                this.elements.exportBtn.addEventListener('click', () => this.exportToCSV());
                this.elements.shareBtn.addEventListener('click', () => this.shareCSV());
                this.elements.clearBtn.addEventListener('click', () => this.showClearConfirmDialog());
                this.elements.confirmDialog.addEventListener('click', (e) => {
                    if (e.target === this.elements.confirmDialog) this.hideClearConfirmDialog();
                });
                this.elements.cancelBtn.addEventListener('click', () => this.hideClearConfirmDialog());
                this.elements.confirmBtn.addEventListener('click', () => this.confirmClear());
                this.elements.blockInput.addEventListener('change', () => this.saveBlockToStorage());
                this.setupKeyboardNavigation();
            }

            setupKeyboardNavigation() {
                this.elements.wellInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        this.elements.blockInput.focus();
                    }
                });
                this.elements.blockInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        this.elements.rockSelect.focus();
                    }
                });
                this.elements.rockSelect.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        this.elements.form.querySelector('.btn-primary').click();
                    }
                });
            }

            loadBlockFromStorage() {
                const savedBlock = localStorage.getItem('lastBlock');
                if (savedBlock) {
                    this.elements.blockInput.value = savedBlock;
                }
            }

            saveBlockToStorage() {
                localStorage.setItem('lastBlock', this.elements.blockInput.value);
            }

            handleBarcodeDetected(barcode) {
                this.elements.barcodeInput.value = barcode;
                setTimeout(() => this.elements.wellInput.focus(), 100);
            }

            showClearConfirmDialog() {
                this.elements.confirmDialog.style.display = 'flex';
            }

            hideClearConfirmDialog() {
                this.elements.confirmDialog.style.display = 'none';
            }

            async confirmClear() {
                this.clearForm();
                this.hideClearConfirmDialog();
                this.hideMessages();
                try {
                    await this.scanner.restartScanning(
                        this.elements.videoElement,
                        (barcode) => this.handleBarcodeDetected(barcode)
                    );
                } catch (error) {
                    console.warn('[APP] –û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞–º–µ—Ä—ã:', error);
                }
            }

            clearForm() {
                this.elements.barcodeInput.value = '';
                this.elements.wellInput.value = '';
                this.elements.rockSelect.value = '520';
            }

            hideMessages() {
                this.elements.errorMsg.style.display = 'none';
                this.elements.successMsg.style.display = 'none';
            }

            async saveRecord() {
                this.hideMessages();
                const barcode = this.elements.barcodeInput.value.trim();
                const well = this.elements.wellInput.value.trim();
                const block = this.elements.blockInput.value.trim();
                const rock = this.elements.rockSelect.value;

                if (!barcode) {
                    this.showError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ —à—Ç—Ä–∏—Ö–∫–æ–¥');
                    return;
                }
                if (!well) {
                    this.showError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Å–∫–≤–∞–∂–∏–Ω—ã');
                    return;
                }
                if (!block) {
                    this.showError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –±–ª–æ–∫–∞');
                    return;
                }

                if (isNaN(parseInt(well)) || parseInt(well) < 1 || parseInt(well) > 999999) {
                    this.showError('–°–∫–≤–∞–∂–∏–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç 1 –¥–æ 999999');
                    return;
                }
                if (isNaN(parseInt(block)) || parseInt(block) < 1 || parseInt(block) > 999999) {
                    this.showError('–ë–ª–æ–∫ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 1 –¥–æ 999999');
                    return;
                }

                try {
                    await this.database.addRecord(barcode, well, block, rock);
                    this.showSuccess(`‚úÖ –ó–∞–ø–∏—Å—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!\n–®—Ç—Ä–∏—Ö–∫–æ–¥: ${barcode}\n–°–∫–≤–∞–∂–∏–Ω–∞: ${well}\n–ë–ª–æ–∫: ${block}\n–ü–æ—Ä–æ–¥–∞: ${rock}`);
                    this.clearForm();
                    await this.updateRecordCount();
                    try {
                        await this.scanner.restartScanning(
                            this.elements.videoElement,
                            (barcode) => this.handleBarcodeDetected(barcode)
                        );
                    } catch (error) {
                        console.warn('[APP] –û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞–º–µ—Ä—ã:', error);
                    }
                    setTimeout(() => this.elements.wellInput.focus(), 100);
                } catch (error) {
                    this.showError('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + error.message);
                }
            }

            async updateRecordCount() {
                try {
                    const records = await this.database.getAllRecords();
                    this.elements.recordCount.textContent = records.length;
                } catch (error) {
                    console.error('[APP] –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–∞:', error);
                }
            }

            async exportToCSV() {
                try {
                    await this.database.downloadCSV();
                    this.showSuccess('‚úÖ CSV —Ñ–∞–π–ª —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω!');
                } catch (error) {
                    this.showError('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: ' + error.message);
                }
            }

            async shareCSV() {
                try {
                    const csv = await this.database.exportToCSV();
                    const timestamp = new Date().toISOString().slice(0, 19).replace(/[-:]/g, '');
                    const filename = `geology_export_${timestamp}.csv`;

                    if (navigator.share) {
                        const blob = new Blob([csv], { type: 'text/csv' });
                        const file = new File([blob], filename, { type: 'text/csv' });
                        await navigator.share({
                            title: '–ì–µ–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ',
                            text: '–≠–∫—Å–ø–æ—Ä—Ç –∑–∞–ø–∏—Å–µ–π',
                            files: [file]
                        });
                        this.showSuccess('‚úÖ –î–∞–Ω–Ω—ã–µ –ø–æ–¥–µ–ª–µ–Ω—ã!');
                    } else {
                        await this.database.downloadCSV();
                        this.showSuccess('‚úÖ CSV —Å–∫–∞—á–∞–Ω (Share API –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞)');
                    }
                } catch (error) {
                    if (error.name !== 'AbortError') {
                        this.showError('–û—à–∏–±–∫–∞ —à–µ—Ä–∏–Ω–≥–∞: ' + error.message);
                    }
                }
            }

            showError(message) {
                this.elements.errorMsg.textContent = message;
                this.elements.errorMsg.style.display = 'block';
            }

            showSuccess(message) {
                this.elements.successMsg.textContent = message;
                this.elements.successMsg.style.display = 'block';
                setTimeout(() => {
                    this.elements.successMsg.style.display = 'none';
                }, 4000);
            }

            async registerServiceWorker() {
                if ('serviceWorker' in navigator) {
                    try {
                        const registration = await navigator.serviceWorker.register('service-worker.js');
                        console.log('[PWA] Service Worker –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω');
                    } catch (error) {
                        console.error('[PWA] –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ Service Worker:', error);
                    }
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            console.log('[MAIN] –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
            window.app = new FieldGeologyApp();
        });
    </script>
</body>
</html>
